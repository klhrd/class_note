<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markmap å‹•æ…‹ç­†è¨˜ç€è¦½å™¨</title>
    <style>
        /* åŸºç¤æ¨£å¼å’Œä½ˆå±€ */
        body { 
            margin: 0; 
            display: flex; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            background-color: #fff;
        }
        /* å´é‚Šæ¬„æ¨£å¼ */
        #sidebar {
            width: 280px; /* å´é‚Šæ¬„å¯¬åº¦ */
            min-width: 280px;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
            padding: 20px 15px;
            box-sizing: border-box;
            background-color: #f7f7f7;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }
        #sidebar h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #1a73e8;
            font-size: 1.25rem;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }
        /* æª”æ¡ˆé€£çµæ¨£å¼ */
        .file-link {
            display: block;
            padding: 8px 10px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-link:hover {
            background-color: #e0e7ff;
            color: #1a73e8;
            border-color: #1a73e8;
        }
        .file-link.active {
            font-weight: bold;
            background-color: #1a73e8;
            color: #ffffff;
            border-color: #1a73e8;
        }

        /* Markmap å®¹å™¨æ¨£å¼ */
        #markmap-container {
            flex-grow: 1; 
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #markmap {
            display: block;
            width: 100%;
            height: 100%;
        }
        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #777;
        }
        .error-message {
            color: red;
            padding: 20px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>ğŸ“‚ ç­†è¨˜æª”æ¡ˆåˆ—è¡¨</h3>
        <div id="file-list">
            <!-- æª”æ¡ˆé€£çµæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            <p class="loading-text" style="font-size: 1rem;">æ­£åœ¨è¼‰å…¥...</p>
        </div>
    </div>
    <div id="markmap-container">
        <svg id="markmap"></svg>
    </div>
    
    <!-- å¼•å…¥ Markmap å¿…è¦å‡½å¼åº« (é€é CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17"></script>

    <script>
        // =================================================================
        //                 ğŸ”” å‹™å¿…ä¿®æ”¹æ­¤è™•çš„ GitHub è³‡è¨Š ğŸ””
        // =================================================================
        const GITHUB_USERNAME = 'klhrd';    // æ‚¨çš„ GitHub ä½¿ç”¨è€…åç¨±
        const REPO_NAME = 'class_note';         // æ‚¨çš„ GitHub å€‰åº«åç¨±
        const TARGET_PATH = '';                     // è¦æƒæçš„å­è³‡æ–™å¤¾è·¯å¾‘ï¼Œæ ¹ç›®éŒ„è«‹ç”¨ ''
        // =================================================================
        
        const API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${TARGET_PATH}`;
        const MARKDOWN_EXTENSION = '.md';

        // Map ç”¨ä¾†å„²å­˜æª”æ¡ˆè·¯å¾‘åˆ° DOM å…ƒç´ çš„æ˜ å°„ï¼Œæ–¹ä¾¿æ¨£å¼æ§åˆ¶
        let fileLinksMap = new Map(); 

        // ====== 1. Markmap æ¸²æŸ“æ ¸å¿ƒå‡½å¼ ======
        async function renderMarkmap(filePath, sourceLink) {
            const markmapEl = document.getElementById('markmap');
            markmapEl.innerHTML = `<div class="loading-text">æ­£åœ¨è¼‰å…¥ ${filePath} çš„å…§å®¹...</div>`;
            
            try {
                // 1. å–å¾— Markdown å…§å®¹ (å¾ Pages æœå‹™å–å¾—)
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥æª”æ¡ˆ: ${filePath} (${response.status})`);
                }
                const markdownContent = await response.text();
                
                // 2. è½‰æ› Markdown ç‚º Markmap è³‡æ–™çµæ§‹
                const { transform } = window.markmap;
                const { root } = transform(markdownContent);
                
                // 3. æ¸²æŸ“ Markmap
                markmapEl.innerHTML = '';
                window.markmap.Markmap.create(markmapEl, null, root);
                
                // 4. è™•ç† Hash èˆ‡æ¨£å¼æ›´æ–°
                if (sourceLink) {
                    // ç§»é™¤æ‰€æœ‰é€£çµçš„ active æ¨£å¼
                    document.querySelectorAll('.file-link').forEach(l => l.classList.remove('active'));
                    
                    // è¨­å®šç•¶å‰é€£çµç‚º active
                    sourceLink.classList.add('active');
                    
                    // æ›´æ–°ç¶²å€ Hash (ä½¿ç”¨ pushState ä¸æœƒåœ¨ç€è¦½å™¨æ­·å²ä¸­ç”¢ç”Ÿé¡å¤–è¨˜éŒ„)
                    history.pushState(null, null, `#${filePath}`);
                }

            } catch (error) {
                console.error("Markmap æ¸²æŸ“éŒ¯èª¤:", error);
                markmapEl.innerHTML = `<div class="error-message">éŒ¯èª¤ï¼šç„¡æ³•æ¸²æŸ“ Markmapã€‚è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æˆ–å…§å®¹ã€‚${error.message}</div>`;
            }
        }

        // ====== 2. é€é GitHub API å–å¾—æª”æ¡ˆåˆ—è¡¨ä¸¦è¨­å®šäº‹ä»¶ ======
        async function fetchFilesAndSetupList() {
            const fileListContainer = document.getElementById('file-list');
            fileListContainer.innerHTML = '<p class="loading-text" style="font-size: 1rem;">æ­£åœ¨å¾ GitHub è¼‰å…¥æª”æ¡ˆåˆ—è¡¨...</p>';

            try {
                // é€é GitHub API å–å¾—ç›®éŒ„å…§å®¹
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`GitHub API è«‹æ±‚å¤±æ•— (Status: ${response.status})ã€‚è«‹ç¢ºèª GITHUB_USERNAME/REPO_NAME/TARGET_PATH æ˜¯å¦æ­£ç¢ºè¨­å®šã€‚`);
                }
                
                const contents = await response.json();
                
                // éæ¿¾å‡ºæ‰€æœ‰çš„ Markdown æª”æ¡ˆ (.md)
                const markdownFiles = contents.filter(item => 
                    item.type === 'file' && item.name.endsWith(MARKDOWN_EXTENSION)
                );

                if (markdownFiles.length === 0) {
                    fileListContainer.innerHTML = '<p class="error-message">æ‰¾ä¸åˆ°ä»»ä½• Markdown æª”æ¡ˆ (.md)ã€‚</p>';
                    return;
                }

                fileListContainer.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥æç¤º
                let hashPath = window.location.hash.substring(1); // å–å¾— Hash (#) å¾Œé¢çš„å…§å®¹
                let defaultFile = null;

                // å»ºç«‹æª”æ¡ˆé€£çµæ¸…å–®
                markdownFiles.forEach(file => {
                    const link = document.createElement('a');
                    link.textContent = file.name; 
                    link.href = `#${file.path}`; // é€£çµçš„ href æŒ‡å‘ Hash
                    link.classList.add('file-link');
                    
                    // å„²å­˜è·¯å¾‘å’Œ DOM å…ƒç´ 
                    fileLinksMap.set(file.path, link);

                    // é»æ“Šäº‹ä»¶ï¼šå‘¼å«æ¸²æŸ“å‡½å¼
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        renderMarkmap(file.path, link);
                    });

                    fileListContainer.appendChild(link);
                    
                    // åˆ¤æ–·åˆå§‹è¼‰å…¥çš„æª”æ¡ˆï¼šå„ªå…ˆä½¿ç”¨ Hashï¼Œå…¶æ¬¡æ˜¯ç¬¬ä¸€å€‹æª”æ¡ˆ
                    if (file.path === hashPath) {
                        defaultFile = { path: file.path, link: link };
                    } else if (!defaultFile) {
                        defaultFile = { path: file.path, link: link };
                    }
                });

                // åˆå§‹è¼‰å…¥ï¼šæ¸²æŸ“ç¬¬ä¸€å€‹æª”æ¡ˆæˆ– Hash æŒ‡å®šçš„æª”æ¡ˆ
                if (defaultFile) {
                    // åˆå§‹è¼‰å…¥æ™‚ï¼Œå¦‚æœ Hash å·²ç¶“åœ¨ç¶²å€åˆ—äº†ï¼Œå‰‡ä¸é‡è¤‡ pushState
                    renderMarkmap(defaultFile.path, defaultFile.path === hashPath ? null : defaultFile.link);
                    if (defaultFile.link) defaultFile.link.classList.add('active'); // ç¢ºä¿æ¨£å¼æ­£ç¢ºå¥—ç”¨
                }

            } catch (error) {
                console.error("è™•ç†æª”æ¡ˆåˆ—è¡¨éŒ¯èª¤:", error);
                fileListContainer.innerHTML = `<p class="error-message">è¼‰å…¥éŒ¯èª¤: ${error.message}</p>`;
            }
        }
        
        // ====== 3. è™•ç†ç€è¦½å™¨è¿”å›/å‰é€²æŒ‰éˆ• (popstate) ======
        window.addEventListener('popstate', () => {
            const hashPath = window.location.hash.substring(1);
            if (hashPath && fileLinksMap.has(hashPath)) {
                // å¦‚æœ Hash å­˜åœ¨ä¸”æª”æ¡ˆåœ¨åˆ—è¡¨ä¸­ï¼Œé‡æ–°æ¸²æŸ“ä¸¦å‚³éé€£çµå…ƒç´ ä»¥æ›´æ–°æ¨£å¼
                renderMarkmap(hashPath, fileLinksMap.get(hashPath));
            } else if (fileLinksMap.size > 0) {
                // å¦‚æœ Hash è¢«æ¸…é™¤æˆ–ç„¡æ•ˆï¼Œè¼‰å…¥åˆ—è¡¨ä¸­çš„ç¬¬ä¸€å€‹æª”æ¡ˆ
                const firstFile = fileLinksMap.keys().next().value;
                renderMarkmap(firstFile, fileLinksMap.get(firstFile));
            }
        });


        // é é¢è¼‰å…¥å¾Œï¼Œé–‹å§‹åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', fetchFilesAndSetupList);
    </script>
</body>
</html>
