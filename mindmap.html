<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markmap å‹•æ…‹ç­†è¨˜ç€è¦½å™¨</title>
    <style>
        /* åŸºç¤æ¨£å¼å’Œä½ˆå±€ */
        body { 
            margin: 0; 
            display: flex; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            background-color: #fff;
        }
        /* å´é‚Šæ¬„æ¨£å¼ */
        #sidebar {
            width: 280px; /* å´é‚Šæ¬„å¯¬åº¦ */
            min-width: 280px;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
            padding: 20px 15px;
            box-sizing: border-box;
            background-color: #f7f7f7;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }
        #sidebar h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #1a73e8;
            font-size: 1.25rem;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 5px;
        }
        /* æª”æ¡ˆé€£çµæ¨£å¼ */
        .file-link {
            display: block;
            padding: 8px 10px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-link.dir-level-1 {
            padding-left: 20px; /* å­ç›®éŒ„æª”æ¡ˆå¢åŠ ç¸®æ’ */
        }
        .file-link.dir-level-2 {
            padding-left: 30px; /* æ›´æ·±çš„å­ç›®éŒ„å¢åŠ ç¸®æ’ */
        }
        .file-link:hover {
            background-color: #e0e7ff;
            color: #1a73e8;
            border-color: #1a73e8;
        }
        .file-link.active {
            font-weight: bold;
            background-color: #1a73e8;
            color: #ffffff;
            border-color: #1a73e8;
        }

        /* Markmap å®¹å™¨æ¨£å¼ */
        #markmap-container {
            flex-grow: 1; 
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #markmap {
            display: block;
            width: 100%;
            height: 100%;
        }
        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #777;
        }
        .error-message {
            color: red;
            padding: 20px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>ğŸ“‚ ç­†è¨˜æª”æ¡ˆåˆ—è¡¨</h3>
        <div id="file-list">
            <!-- æª”æ¡ˆé€£çµæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            <p class="loading-text" style="font-size: 1rem;">æ­£åœ¨è¼‰å…¥...</p>
        </div>
    </div>
    <div id="markmap-container">
        <svg id="markmap"></svg>
    </div>
    
    <!-- å¼•å…¥ Markmap å¿…è¦å‡½å¼åº« (é€é CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17"></script>

    <script>
        // =================================================================
        //                 ğŸ”” GitHub è³‡è¨Š (å·²å¾æ‚¨çš„è¼¸å…¥ä¸­æå–) ğŸ””
        // =================================================================
        const GITHUB_USERNAME = 'klhrd';    
        const REPO_NAME = 'class_note';         
        const TARGET_PATH = '';                     
        // =================================================================
        
        const MARKDOWN_EXTENSION = '.md';

        // Map ç”¨ä¾†å„²å­˜æª”æ¡ˆè·¯å¾‘åˆ° DOM å…ƒç´ çš„æ˜ å°„ï¼Œæ–¹ä¾¿æ¨£å¼æ§åˆ¶
        let fileLinksMap = new Map(); 

        // ====== 1. Markmap æ¸²æŸ“æ ¸å¿ƒå‡½å¼ (åŠŸèƒ½ä¸è®Š) ======
        async function renderMarkmap(filePath, sourceLink) {
            const markmapEl = document.getElementById('markmap');
            markmapEl.innerHTML = `<div class="loading-text">æ­£åœ¨è¼‰å…¥ ${filePath} çš„å…§å®¹...</div>`;
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥æª”æ¡ˆ: ${filePath} (${response.status})`);
                }
                const markdownContent = await response.text();
                
                const { transform } = window.markmap;
                const { root } = transform(markdownContent);
                
                markmapEl.innerHTML = '';
                window.markmap.Markmap.create(markmapEl, null, root);
                
                // è™•ç† Hash èˆ‡æ¨£å¼æ›´æ–°
                if (sourceLink) {
                    document.querySelectorAll('.file-link').forEach(l => l.classList.remove('active'));
                    sourceLink.classList.add('active');
                    history.pushState(null, null, `#${filePath}`);
                }

            } catch (error) {
                console.error("Markmap æ¸²æŸ“éŒ¯èª¤:", error);
                markmapEl.innerHTML = `<div class="error-message">éŒ¯èª¤ï¼šç„¡æ³•æ¸²æŸ“ Markmapã€‚è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æˆ–å…§å®¹ã€‚${error.message}</div>`;
            }
        }

        // ====== 2. éè¿´å–å¾— Markdown æª”æ¡ˆåˆ—è¡¨ (æ–°å¢) ======
        async function getMarkdownFiles(path) {
            const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${path}`;
            
            // é€é GitHub API å–å¾—ç›®éŒ„å…§å®¹
            const response = await fetch(url);
            
            if (!response.ok) {
                // å¦‚æœ API è«‹æ±‚å¤±æ•—ï¼Œå¯èƒ½æ˜¯è·¯å¾‘ç„¡æ•ˆï¼Œç›´æ¥è¿”å›ç©ºé™£åˆ—
                console.warn(`Skipping path ${path} due_to_API_error: ${response.status}`);
                return [];
            }
            
            const contents = await response.json();
            let files = [];
            
            for (const item of contents) {
                if (item.type === 'file' && item.name.endsWith(MARKDOWN_EXTENSION)) {
                    // æ”¶é›† Markdown æª”æ¡ˆ
                    files.push({
                        name: item.name,
                        path: item.path, // å®Œæ•´çš„æª”æ¡ˆè·¯å¾‘ (ä¾‹å¦‚: 'chinese/lesson1.md')
                    });
                } else if (item.type === 'dir') {
                    // éè¿´å‘¼å«å­è³‡æ–™å¤¾
                    const subFiles = await getMarkdownFiles(item.path);
                    files = files.concat(subFiles);
                }
            }
            return files;
        }

        // ====== 3. åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ======
        async function initializeApp() {
            const fileListContainer = document.getElementById('file-list');
            fileListContainer.innerHTML = '<p class="loading-text" style="font-size: 1rem;">æ­£åœ¨å¾ GitHub è¼‰å…¥æª”æ¡ˆåˆ—è¡¨...</p>';

            try {
                // éè¿´å–å¾—æ‰€æœ‰ Markdown æª”æ¡ˆ
                const markdownFiles = await getMarkdownFiles(TARGET_PATH);

                if (markdownFiles.length === 0) {
                    fileListContainer.innerHTML = '<p class="error-message">æ‰¾ä¸åˆ°ä»»ä½• Markdown æª”æ¡ˆ (.md)ã€‚</p>';
                    return;
                }

                fileListContainer.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥æç¤º
                let hashPath = window.location.hash.substring(1); 
                let defaultFile = null;

                // å»ºç«‹æª”æ¡ˆé€£çµæ¸…å–®
                markdownFiles.forEach(file => {
                    const link = document.createElement('a');
                    // é¡¯ç¤ºå®Œæ•´çš„æª”æ¡ˆè·¯å¾‘ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æª”æ¡ˆåœ¨å“ªå€‹è³‡æ–™å¤¾
                    link.textContent = file.path; 
                    link.href = `#${file.path}`; 
                    link.classList.add('file-link');
                    
                    // æ ¹æ“šè·¯å¾‘æ·±åº¦å¢åŠ ç¸®æ’æ¨£å¼ (ä¾‹å¦‚ 'chinese/lesson1.md' æœ‰å…©å±¤)
                    const pathDepth = file.path.split('/').length - 1;
                    if (pathDepth > 0) {
                        // ä½¿ç”¨ dir-level-X æ¨£å¼å¯¦ç¾ç¸®æ’
                        link.classList.add(`dir-level-${Math.min(pathDepth, 2)}`); 
                    }
                    
                    fileLinksMap.set(file.path, link);

                    link.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        renderMarkmap(file.path, link);
                    });

                    fileListContainer.appendChild(link);
                    
                    // åˆ¤æ–·åˆå§‹è¼‰å…¥çš„æª”æ¡ˆ
                    if (file.path === hashPath) {
                        defaultFile = { path: file.path, link: link };
                    } else if (!defaultFile) {
                        defaultFile = { path: file.path, link: link };
                    }
                });

                // åˆå§‹è¼‰å…¥ï¼šæ¸²æŸ“ç¬¬ä¸€å€‹æª”æ¡ˆæˆ– Hash æŒ‡å®šçš„æª”æ¡ˆ
                if (defaultFile) {
                    renderMarkmap(defaultFile.path, defaultFile.path === hashPath ? null : defaultFile.link);
                    if (defaultFile.link) defaultFile.link.classList.add('active'); 
                }

            } catch (error) {
                console.error("åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:", error);
                fileListContainer.innerHTML = `<p class="error-message">è¼‰å…¥éŒ¯èª¤: ${error.message}</p>`;
            }
        }
        
        // ====== 4. è™•ç†ç€è¦½å™¨è¿”å›/å‰é€²æŒ‰éˆ• (popstate) (åŠŸèƒ½ä¸è®Š) ======
        window.addEventListener('popstate', () => {
            const hashPath = window.location.hash.substring(1);
            if (hashPath && fileLinksMap.has(hashPath)) {
                renderMarkmap(hashPath, fileLinksMap.get(hashPath));
            } else if (fileLinksMap.size > 0) {
                const firstFile = fileLinksMap.keys().next().value;
                renderMarkmap(firstFile, fileLinksMap.get(firstFile));
            }
        });


        // é é¢è¼‰å…¥å¾Œï¼Œé–‹å§‹åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
